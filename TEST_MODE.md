# Тестовый режим энкодера

## Описание

Тестовый режим позволяет проверить работу энкодера без запуска основного функционала логического анализатора. Этот режим полезен для:
- Проверки работоспособности энкодера
- Калибровки и тестирования аппаратной части
- Отладки считывания энкодера

## Активация тестового режима

Для входа в тестовый режим нужно:

1. **Зажать кнопку TEST_BTN (PA0)** на плате
2. **Подать питание** или нажать кнопку RESET
3. **Удерживать TEST_BTN** до момента инициализации системы
4. **Отпустить TEST_BTN** после появления изображения на дисплее

### Аппаратная конфигурация

- **Пин:** PA0 (GPIOA, Pin 0)
- **Режим:** INPUT с внутренней подтяжкой PULL-UP
- **Логика:** Active LOW (кнопка замыкает PA0 на GND)

## Отображение на OLED

В тестовом режиме на OLED дисплее отображается:

```
TEST MODE
Pos: 0
BTN: RELEASED
Long: Reset
```

### Информация на дисплее

| Строка | Описание |
|--------|----------|
| **TEST MODE** | Индикатор активного тестового режима |
| **Pos: X** | Текущая позиция энкодера (целое число) |
| **BTN: PRESSED** | Состояние кнопки энкодера (PRESSED/RELEASED) |
| **Long: Reset** | Подсказка - длинное нажатие сбрасывает позицию |

## Функционал

### 1. Отображение позиции

Энкодер считает импульсы при вращении:
- **По часовой стрелке (CW)** → позиция увеличивается
- **Против часовой стрелки (CCW)** → позиция уменьшается

Позиция обновляется на дисплее в реальном времени.

### 2. Состояние кнопки

Отображается текущее состояние кнопки энкодера:
- **PRESSED** - кнопка нажата
- **RELEASED** - кнопка отпущена

### 3. Сброс позиции (Long Press)

При длительном нажатии кнопки энкодера (> 500 мс):
- Позиция сбрасывается в **0**
- В логи выводится сообщение: `[TEST] Position reset to 0`

## Логирование через USB CDC

Все события энкодера выводятся в USB CDC (Virtual COM Port):

### Примеры логов

```
[TEST] Pos: 5, Delta: 1
[TEST] Pos: 6, Delta: 1
[TEST] Button PRESSED
[TEST] Button RELEASED
[TEST] Pos: 5, Delta: -1
[TEST] Position reset to 0
```

### Типы событий в логах

| Сообщение | Описание |
|-----------|----------|
| `[TEST] Pos: X, Delta: Y` | Изменение позиции энкодера |
| `[TEST] Button PRESSED` | Кнопка энкодера нажата |
| `[TEST] Button RELEASED` | Кнопка энкодера отпущена |
| `[TEST] Position reset to 0` | Позиция сброшена длинным нажатием |

## Выход из тестового режима

Чтобы выйти из тестового режима:

1. **Нажать кнопку RESET** на плате
2. **Не удерживать TEST_BTN** во время загрузки
3. Устройство запустится в **обычном режиме** логического анализатора

## Технические детали

### Код активации

```cpp
// В main.cpp, после инициализации GPIO
if (HAL_GPIO_ReadPin(TEST_BTN_GPIO_Port, TEST_BTN_Pin) == GPIO_PIN_RESET) {
    g_test_mode = true;
}
```

### Частота обновления

- **Polling rate:** 100 Hz (каждые 10 мс)
- **Display update:** При изменении позиции или состояния кнопки
- **Debounce:** Встроенный в класс Encoder (программный debounce)

### Использование памяти

Тестовый режим добавляет минимальные накладные расходы:

**До добавления тестового режима:**
- RAM: 27,096 B
- FLASH: 64,616 B

**После добавления тестового режима:**
- RAM: 27,112 B (+16 B)
- FLASH: 65,336 B (+720 B)

**Прирост:**
- RAM: +16 байт (0.02%)
- FLASH: +720 байт (0.28%)

## Практическое применение

### 1. Проверка подключения энкодера

Убедитесь, что:
- Вращение энкодера изменяет позицию
- Направление вращения соответствует изменению значения
- Нет пропусков импульсов

### 2. Проверка кнопки энкодера

Проверьте:
- Короткие нажатия корректно детектируются
- Длинное нажатие (>500 мс) сбрасывает позицию
- Нет дребезга контактов

### 3. Отладка USB CDC

Подключите к терминалу (например, minicom, screen, или Arduino Serial Monitor):

```bash
# Linux
screen /dev/ttyACM0 115200

# Или
minicom -D /dev/ttyACM0

# Windows
# Используйте PuTTY или Tera Term
```

### 4. Проверка OLED дисплея

Убедитесь, что:
- Все строки корректно отображаются
- Обновление происходит без задержек
- Нет артефактов на экране

## Схема подключения TEST_BTN

```
         STM32F401
         ┌─────┐
    PA0──┤     │
         │     │
    GND──┤     │
         └─────┘

    [Button]
      │  │
      └──┴─── При нажатии замыкает PA0 на GND
```

**Рекомендуемая схема:**
- Внешняя кнопка между PA0 и GND
- Используется внутренняя подтяжка (PULL-UP)
- Опционально: внешний конденсатор 100 нФ для дебаунса (не обязательно)

## Известные ограничения

1. **Вход только при загрузке** - переключение режимов возможно только при старте системы
2. **Без динамического переключения** - нельзя переключиться в тест-режим из обычного без перезагрузки
3. **Один режим работы** - либо тестовый режим, либо логический анализатор

## Расширение функционала

В будущем можно добавить:

- [ ] Тест всех GPIO пинов
- [ ] Тест I2C коммуникации с OLED
- [ ] Тест RTC и временных меток
- [ ] Меню с выбором различных тестов
- [ ] Сохранение статистики тестирования
- [ ] Автоматический тест с самопроверкой

---

**Версия документа:** 1.0
**Дата создания:** 2025-12-04
**Автор:** Claude Code + Victor
