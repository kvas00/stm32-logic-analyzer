# Changelog

## [Version 0.4-date-time] - 2025-10-10 ✅ CURRENT

### Добавлено
- **Отображение версии прошивки**
  - `FW_VERSION` define в main.cpp
  - Вывод на OLED при старте: "Encoder-Only" + версия (2 сек)
  - Баннер в логах с версией и временем сборки
- **Улучшенное логирование**
  - Объединение timestamp + message в один буфер (атомарная передача)
  - Исправлена проблема с разделением логов
  - Более надежная работа при concurrent logging

### Изменено
- `Core/Src/main.cpp`:
  - Добавлен `#define FW_VERSION "v0.4-date-time"` (строка 47)
  - OLED показывает версию при старте 2 секунды
  - Startup banner в логах с версией и build timestamp
  - Log_Printf теперь объединяет timestamp+message в один буфер
- Улучшена логика форматирования логов для избежания разрыва сообщений

### Технические характеристики
- **RAM**: 27,080 байт / 64 КБ (41.32%) - без изменений
- **FLASH**: 61,020 байт / 256 КБ (23.28%) - +228 байт (версия + баннер)

### Формат вывода

**OLED при старте (2 секунды):**
```
Encoder-Only
v0.4-date-time
```

**Затем переключается на:**
```
10.10.25
14:00:03
Pos: 0
```

**Логи при старте:**
```
[10.10.25 14:00:00] =================================
[10.10.25 14:00:00] Firmware: v0.4-date-time
[10.10.25 14:00:00] Build: Oct 10 2025 15:30:45
[10.10.25 14:00:00] System started
[10.10.25 14:00:00] =================================
```

### Резервная копия
- Полная резервная копия в `BACKUP/v0.4-date-time/`
- Документация: `README.md`
- Checksums: `checksums.sha256`
- Скомпилированные файлы: `encoder-only.elf`, `encoder-only.map`

### Откат к этой версии
```bash
cp BACKUP/v0.4-date-time/Core/Src/main.cpp Core/Src/
cp BACKUP/v0.4-date-time/Core/Lib/Tasks.* Core/Lib/
cd build && ninja
```

---

## [Version 0.5-logging-channels] - 2025-10-10 ✅ MERGED

### Добавлено
- **Раздельное управление каналами логирования**
  - `LOG_UART_ENABLED` - включить/выключить вывод в UART
  - `LOG_USB_ENABLED` - включить/выключить вывод в USB CDC
  - VERBOSE имеет приоритет над каналами (если VERBOSE=0, все каналы отключены)

### Изменено
- `Core/Src/main.cpp`:
  - Добавлены defines `LOG_UART_ENABLED` и `LOG_USB_ENABLED` (строки 51-52)
  - Модифицирована `Log_Printf()` для раздельного управления каналами
  - UART и USB передача теперь контролируется отдельными #if директивами

### Технические характеристики
- **RAM**: 27,080 байт / 64 КБ (41.32%) - без изменений
- **FLASH**: 60,824 байт / 256 КБ (23.20%) - без изменений

### Варианты конфигурации

| VERBOSE | UART | USB | Результат |
|---------|------|-----|-----------|
| 0 | X | X | Логирование полностью отключено |
| 1 | 0 | 0 | Логирование работает, но нет вывода |
| 1 | 1 | 0 | Только UART |
| 1 | 0 | 1 | Только USB CDC |
| 1 | 1 | 1 | Оба канала (по умолчанию) |

### Документация
- Полное описание: [LOGGING_CONFIGURATION.md](LOGGING_CONFIGURATION.md)
- Примеры конфигурации, матрица приоритетов, best practices

---

## [Version 0.4-rtc-logging] - 2025-10-10 ✅ STABLE

### Добавлено
- **RTC календарь с поддержкой временных меток**
  - Инициализация RTC с внешним кварцем 32.768 kHz (LSE)
  - Начальное время: 10.10.2025 14:00:00
  - Формат временной метки: `[DD.MM.YY HH:MM:SS]`
  - Автоматическое добавление timestamp к каждому лог-сообщению
- **Управление выводом логов через VERBOSE**
  - `#define VERBOSE 1` - включить логирование
  - `#define VERBOSE 0` - выключить логирование (экономия памяти)
  - Компилируется на этапе сборки (нет накладных расходов)

### Изменено
- `Core/Src/main.cpp`:
  - Добавлен `#define VERBOSE 1` (строка 47)
  - Модифицирована `Log_Printf()` для добавления timestamps
  - Добавлена инициализация RTC календаря в `MX_RTC_Init()` (строки 423-446)
  - Установка начальной даты/времени: 10.10.2025 14:00:00
  - Чтение времени через `HAL_RTC_GetTime()` и `HAL_RTC_GetDate()`

### Технические характеристики
- **RAM**: 27,072 байт / 64 КБ (41.31%) - без изменений
- **FLASH**: 60,672 байт / 256 КБ (23.14%) - +1,396 байт
- **RTC**: Внешний кварц LSE 32.768 kHz
- **Формат времени**: 24-часовой формат

### Формат вывода логов
Пример с timestamp:
```
[10.10.25 14:00:03] Enter button pressed
[10.10.25 14:00:05] Current pos: 5 (CW, delta: 1)
[10.10.25 14:00:08] Enter button released
```

### Управление логированием
```cpp
#define VERBOSE 1  // Логирование включено
#define VERBOSE 0  // Логирование выключено (экономия ~1.4 KB FLASH)
```

### Документация
- Полное описание: [RTC_LOGGING_FEATURES.md](RTC_LOGGING_FEATURES.md)
- Примеры использования, конфигурация, troubleshooting

---

## [Version 0.3-oled] - 2025-10-10 ✅ STABLE

### Добавлено
- **OLED дисплей с отображением позиции энкодера**
  - Вывод сообщения "Sys Started" при запуске системы
  - Отображение текущей позиции энкодера: "Pos: X"
  - Обновление дисплея только при изменении позиции (оптимизация)
- Интеграция OLED в main.cpp:
  - Глобальный объект `display::Oled* oled`
  - Экспортированный указатель `g_oled` для доступа из задач
  - Инициализация OLED через I2C1
- Модификация testTask для работы с дисплеем:
  - Мониторинг изменений позиции энкодера
  - Динамическое обновление дисплея
  - Двухстрочный вывод: название + позиция

### Изменено
- `Core/Src/main.cpp`:
  - Добавлен `#include "Oled.hpp"`
  - Создание объекта OLED: `oled = new display::Oled(&hi2c1)`
  - Инициализация и вывод стартового сообщения
  - Экспорт g_oled для задач
- `Core/Lib/Tasks.cpp`:
  - Добавлена переменная отслеживания позиции: `static int last_position`
  - Добавлен буфер для форматирования: `char buffer[32]`
  - Реализована логика обновления OLED при изменении позиции
  - Отображение двух строк: "Sys Started" и "Pos: X"
- `Core/Lib/Tasks.h`:
  - Добавлен `#include "Oled.hpp"`
  - Добавлен `extern display::Oled* g_oled`

### Технические характеристики
- **RAM**: 27072 байт / 64 КБ (41.31%)
- **FLASH**: 59276 байт / 256 КБ (22.61%)
- **Дисплей**: SH1106 128x64, I2C адрес 0x3C
- **Частота обновления**: по изменению позиции (эффективно)

### Резервная копия
- Полная резервная копия в `BACKUP/v0.3-oled/`
- Документация: `VERSION_INFO.md`
- Инструкции отката: `ROLLBACK_INSTRUCTIONS.md`
- Скомпилированные файлы: `encoder-only.elf`, `encoder-only.map`

### Откат к этой версии
```bash
# Быстрый откат
cp BACKUP/v0.3-oled/Core/Src/main.cpp Core/Src/
cp BACKUP/v0.3-oled/Core/Lib/Tasks.* Core/Lib/
cp BACKUP/v0.3-oled/Core/Lib/Oled.* Core/Lib/
cd build && ninja
```

Подробнее: см. `BACKUP/v0.3-oled/ROLLBACK_INSTRUCTIONS.md`

---

## [Unreleased] - FreeRTOS Integration

### Добавлено
- Поддержка FreeRTOS с двумя задачами
- `ledTask` - heartbeat индикация (мигание LED каждые 500 мс)
- `testTask` - тестирование энкодера с выводом в лог
- Библиотека OLED (SH1106 128x64):
  - C++ wrapper: `Oled.hpp`, `Oled.cpp`
  - C driver: `sh1106.h`, `sh1106.c`, `sh1106_font.h`, `sh1106_font.c`
- Файл задач: `Tasks.h`, `Tasks.cpp`
- Документация: `FREERTOS_TASKS.md`

### Изменено
- `main.cpp` адаптирован для FreeRTOS:
  - Убран код из главного цикла
  - Добавлено создание задач ledTask и testTask
  - Глобальные указатели g_led и g_encoder для доступа из задач
- `CMakeLists.txt`:
  - Добавлены новые исходники: Oled.cpp, Tasks.cpp, sh1106.c, sh1106_font.c

### Структура проекта

```
Core/
├── Inc/
│   ├── sh1106.h
│   └── sh1106_font.h
├── Lib/
│   ├── Encoder.h/cpp
│   ├── Led.h/cpp
│   ├── Oled.hpp/cpp
│   └── Tasks.h/cpp
└── Src/
    ├── main.cpp
    ├── sh1106.c
    └── sh1106_font.c
```

### Задачи FreeRTOS

1. **ledTask** (Priority: Low, Stack: 512 bytes)
   - Период: 500 мс
   - Функция: Heartbeat - переключение LED

2. **testTask** (Priority: Normal, Stack: 1024 bytes)
   - Период: 10 мс (100 Hz)
   - Функция: Тестирование энкодера, вывод событий в лог

3. **defaultTask** (Priority: Normal, Stack: 512 bytes)
   - Стандартная задача CubeMX
   - Доступна для использования

### Следующие шаги

- Добавить поддержку I2C для OLED
- Создать задачу отображения на OLED
- Добавить меню управления через энкодер

## [Version 0.1] - 2025-10-10

### Базовая версия
- Классы Encoder и Led
- Обработка энкодера с прерываниями
- LED индикация
- Параллельный вывод логов в UART1 и USB-CDC
